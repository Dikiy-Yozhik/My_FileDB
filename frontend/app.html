<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My_FileDB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        
        .header { 
            background: #2c3e50; color: white; padding: 1rem; 
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        
        .card { 
            background: white; border-radius: 8px; padding: 1.5rem; 
            margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn { 
            background: #3498db; color: white; border: none; padding: 0.5rem 1rem;
            border-radius: 4px; cursor: pointer; margin: 0.25rem;
        }
        .btn:hover { background: #2980b9; }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #219a52; }
        
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        
        .status { padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        
        table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; font-weight: bold; }
        
        .form-group { margin: 1rem 0; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        input, select { 
            width: 100%; padding: 0.5rem; border: 1px solid #ddd; 
            border-radius: 4px; font-size: 1rem;
        }
        
        .hidden { display: none; }
        .login-container { 
            max-width: 400px; margin: 2rem auto; padding: 2rem;
            background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- –õ–æ–≥–∏–Ω —Ñ–æ—Ä–º–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–Ω–∞—á–∞–ª–∞) -->
    <div id="login-section">
        <div class="login-container">
            <h1 style="text-align: center; margin-bottom: 1.5rem;">üóÉÔ∏è My_FileDB</h1>
            
            <div id="login-status" class="status"></div>
            
            <form id="login-form">
                <div class="form-group">
                    <label>–õ–æ–≥–∏–Ω:</label>
                    <input type="text" id="username" value="admin" required>
                </div>
                
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" value="admin123" required>
                </div>
                
                <button type="submit" class="btn" style="width: 100%;">–í–æ–π—Ç–∏</button>
            </form>
            
            <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 4px; font-size: 0.9rem;">
                <strong>–î–µ–º–æ-–∞–∫–∫–∞—É–Ω—Ç—ã:</strong><br>
                ‚Ä¢ admin / admin123 (–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)<br>
                ‚Ä¢ operator / operator123 (–û–ø–µ—Ä–∞—Ç–æ—Ä)<br>
                ‚Ä¢ user / user123 (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (—Å–∫—Ä—ã—Ç –¥–æ –≤—Ö–æ–¥–∞) -->
    <div id="app-section" class="hidden">
        <div class="header">
            <h1>üóÉÔ∏è My_FileDB</h1>
            <div>
                <span id="user-info">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
                <button id="logout-btn" class="btn btn-danger">–í—ã–π—Ç–∏</button>
            </div>
        </div>

        <div class="container">
            <!-- –°—Ç–∞—Ç—É—Å -->
            <div id="status-message" class="status"></div>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ë–î -->
            <div class="card">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö</h2>
                <div class="form-group">
                    <label>–ü—É—Ç—å –∫ –ë–î:</label>
                    <input type="text" id="db-path" placeholder="data/mydatabase" value="data/mydatabase">
                </div>
                <button id="create-db" class="btn">–°–æ–∑–¥–∞—Ç—å –ë–î</button>
                <button id="load-db" class="btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ë–î</button>
                <button id="backup-db" class="btn" disabled>–°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø</button>
                <button id="export-excel" class="btn btn-success" disabled>–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
                <button id="clear-db" class="btn btn-danger" disabled>–û—á–∏—Å—Ç–∏—Ç—å –ë–î</button>
            </div>

            <!-- –ü–æ–∏—Å–∫ -->
            <div class="card">
                <h2>–ü–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h2>
                <div style="display: flex; gap: 1rem; align-items: end;">
                    <div class="form-group" style="flex: 1;">
                        <label>–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏:</label>
                        <input type="text" id="search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è...">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>–û—Ç–¥–µ–ª:</label>
                        <select id="department-filter">
                            <option value="">–í—Å–µ –æ—Ç–¥–µ–ª—ã</option>
                            <option value="IT">IT</option>
                            <option value="HR">HR</option>
                            <option value="Finance">–§–∏–Ω–∞–Ω—Å—ã</option>
                            <option value="Marketing">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</option>
                        </select>
                    </div>
                    <button id="search-btn" class="btn">–ü–æ–∏—Å–∫</button>
                    <button id="clear-search" class="btn">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
            </div>

            <!-- –¢–∞–±–ª–∏—Ü–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2>
                    <button id="add-employee" class="btn" disabled>–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–§–ò–û</th>
                            <th>–û—Ç–¥–µ–ª</th>
                            <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                            <th>–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
                            <th>–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="employees-table">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem;">
                                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div style="margin-top: 1rem;">
                    <strong id="record-count">–ó–∞–ø–∏—Å–µ–π: 0</strong>
                </div>
            </div>

            <!-- –§–æ—Ä–º–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -->
            <!-- –§–æ—Ä–º–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -->
            <div id="employee-form" class="card hidden">
                <h2 id="form-title">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
                <form id="employee-data-form">
                    <input type="hidden" id="employee-id">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <!-- üî• –î–û–ë–ê–í–õ–ï–ù–û –ü–û–õ–ï ID -->
                        <div class="form-group">
                            <label for="employee-id-input">ID *</label>
                            <input type="number" id="employee-id-input" min="1" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="employee-name">–§–ò–û *</label>
                            <input type="text" id="employee-name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="employee-department">–û—Ç–¥–µ–ª *</label>
                            <select id="employee-department" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>
                                <option value="IT">IT</option>
                                <option value="HR">HR</option>
                                <option value="Finance">–§–∏–Ω–∞–Ω—Å—ã</option>
                                <option value="Marketing">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="employee-position">–î–æ–ª–∂–Ω–æ—Å—Ç—å *</label>
                            <input type="text" id="employee-position" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="employee-salary">–ó–∞—Ä–ø–ª–∞—Ç–∞ *</label>
                            <input type="number" id="employee-salary" step="0.01" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="employee-hireDate">–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞ *</label>
                            <input type="date" id="employee-hireDate" required>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button type="button" id="cancel-form" class="btn btn-danger">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        class SinglePageApp {
            constructor() {
                this.apiBase = 'http://localhost:8080';
                this.currentUser = null;
                this.currentToken = null; // üî• –ù–û–í–û–ï: —Ö—Ä–∞–Ω–∏–º —Ç–æ–∫–µ–Ω
                this.currentDatabase = null;
                this.employees = [];
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.checkExistingAuth();
            }

            checkExistingAuth() {
                const savedToken = localStorage.getItem('authToken');
                const savedUser = localStorage.getItem('userData');
                
                if (savedToken && savedUser) {
                    try {
                        this.currentToken = savedToken;
                        this.currentUser = JSON.parse(savedUser);
                        console.log('‚úÖ Restored auth from localStorage:', this.currentUser);
                        this.showApp();
                        this.validateToken(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω –µ—â–µ –≤–∞–ª–∏–¥–µ–Ω
                    } catch (e) {
                        console.error('‚ùå Error restoring auth:', e);
                        this.clearAuth();
                        this.showLogin();
                    }
                } else {
                    this.showLogin();
                }
            }

            // üî• –ù–û–í–´–ô –ú–ï–¢–û–î: –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            async validateToken() {
                try {
                    const response = await this.fetchAPI('/auth/status');
                    if (response.success && response.data.authenticated) {
                        console.log('‚úÖ Token is valid');
                        return true;
                    } else {
                        console.log('‚ùå Token expired');
                        this.clearAuth();
                        this.showLogin();
                        return false;
                    }
                } catch (error) {
                    console.error('üí• Token validation error:', error);
                    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                    return true;
                }
            }

            async checkExistingSession() {
                try {
                    const response = await this.fetchAPI('/auth/status');
                    if (response.success && response.data.authenticated) {
                        this.currentUser = response.data;
                        this.showApp();
                    } else {
                        this.showLogin();
                    }
                } catch (error) {
                    this.showLogin();
                }
            }

            setupEventListeners() {
                // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏...
                document.getElementById('login-form').addEventListener('submit', (e) => this.handleLogin(e));
                document.getElementById('logout-btn').addEventListener('click', () => this.logout());
                document.getElementById('create-db').addEventListener('click', () => this.createDatabase());
                document.getElementById('load-db').addEventListener('click', () => this.loadDatabase());
                document.getElementById('add-employee').addEventListener('click', () => this.showEmployeeForm());
                document.getElementById('employee-data-form').addEventListener('submit', (e) => this.saveEmployee(e));
                document.getElementById('cancel-form').addEventListener('click', () => this.hideEmployeeForm());
                
                // üî• –î–û–ë–ê–í–¨–¢–ï –≠–¢–ò –ù–û–í–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò:
                document.getElementById('search-btn').addEventListener('click', () => this.searchEmployees());
                document.getElementById('clear-search').addEventListener('click', () => this.clearSearch());
                document.getElementById('export-excel').addEventListener('click', () => this.exportToExcel());
                document.getElementById('clear-db').addEventListener('click', () => this.clearDatabase());
                document.getElementById('backup-db').addEventListener('click', () => this.createBackup());
            }

            async handleLogin(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const statusElement = document.getElementById('login-status');

                if (!username || !password) {
                    this.showLoginStatus('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                    return;
                }

                try {
                    this.showLoginStatus('–í—Ö–æ–¥...', 'info');
                    
                    const response = await this.fetchAPI('/auth/login', 'POST', { 
                        username, 
                        password 
                    }, false); // üî• false = –±–µ–∑ —Ç–æ–∫–µ–Ω–∞

                    console.log('üìä Login response:', response);

                    if (response.success) {
                        // üî• –°–û–•–†–ê–ù–Ø–ï–ú –¢–û–ö–ï–ù –ò –î–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
                        if (response.token) {
                            this.currentToken = response.token;
                            this.currentUser = response.data;
                            
                            localStorage.setItem('authToken', this.currentToken);
                            localStorage.setItem('userData', JSON.stringify(this.currentUser));
                            
                            console.log('üîë Token saved:', this.currentToken);
                        } else {
                            console.warn('‚ö†Ô∏è No token in response');
                            this.currentUser = response.data;
                        }
                        
                        this.showLoginStatus('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!', 'success');
                        setTimeout(() => this.showApp(), 500);
                    } else {
                        this.showLoginStatus(response.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', 'error');
                    }
                } catch (error) {
                    this.showLoginStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                    console.error('Login error:', error);
                }
            }

            showLogin() {
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('app-section').classList.add('hidden');
            }

            showApp() {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('app-section').classList.remove('hidden');
                this.updateUserInfo();
                this.enableControls(true);
                this.showStatus(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${this.currentUser.username}!`, 'success');
            }

            showLoginStatus(message, type) {
                const element = document.getElementById('login-status');
                element.textContent = message;
                element.className = `status ${type}`;
            }

            showStatus(message, type = 'info') {
                const element = document.getElementById('status-message');
                element.textContent = message;
                element.className = `status ${type}`;
            }

            updateUserInfo() {
                const element = document.getElementById('user-info');
                if (element && this.currentUser) {
                    element.textContent = `${this.currentUser.username} (${this.currentUser.role})`;
                }
            }

            enableControls(enabled) {
                const controls = ['add-employee', 'backup-db', 'export-excel', 'clear-db'];
                controls.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.disabled = !enabled;
                });
            }

            async logout() {
                try {
                    await this.fetchAPI('/auth/logout', 'POST');
                } catch (error) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
                }
                
                this.clearAuth();
                this.showLogin();
            }

            // üî• –ù–û–í–´–ô –ú–ï–¢–û–î: –æ—á–∏—Å—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            clearAuth() {
                this.currentUser = null;
                this.currentToken = null;
                localStorage.removeItem('authToken');
                localStorage.removeItem('userData');
            }


            async createDatabase() {
                const path = document.getElementById('db-path').value || 'data/mydatabase';
                
                this.showStatus('–°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...', 'info');
                try {
                    const result = await this.fetchAPI('/database/create', 'POST', { databasePath: path });
                    
                    if (result.success) {
                        this.currentDatabase = path;
                        this.showStatus('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                        await this.loadEmployees();
                    } else {
                        this.showStatus(`–û—à–∏–±–∫–∞: ${result.message}`, 'error');
                    }
                } catch (error) {
                    this.showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ë–î', 'error');
                }
            }

            async loadDatabase() {
                const path = document.getElementById('db-path').value || 'data/mydatabase';
                
                this.showStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...', 'info');
                try {
                    const result = await this.fetchAPI('/database/load', 'POST', { databasePath: path });
                    
                    if (result.success) {
                        this.currentDatabase = path;
                        this.showStatus('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                        await this.loadEmployees();
                    } else {
                        this.showStatus(`–û—à–∏–±–∫–∞: ${result.message}`, 'error');
                    }
                } catch (error) {
                    this.showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ë–î', 'error');
                }
            }

            showEmployeeForm(employee = null) {
                const form = document.getElementById('employee-form');
                const title = document.getElementById('form-title');
                const formElement = document.getElementById('employee-data-form');
                
                if (!form || !title || !formElement) {
                    console.error('‚ùå Employee form elements not found!');
                    return;
                }

                if (employee) {
                    title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞';
                    this.fillEmployeeForm(employee);
                } else {
                    title.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞';
                    formElement.reset();
                    // üî• –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                    this.generateNewEmployeeId();
                }
                
                form.classList.remove('hidden');
            }

            // üî• –ù–û–í–´–ô –ú–ï–¢–û–î: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è ID –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            generateNewEmployeeId() {
                if (this.employees.length > 0) {
                    // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π ID –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–∞ 1
                    const maxId = Math.max(...this.employees.map(emp => emp.id));
                    document.getElementById('employee-id-input').value = maxId + 1;
                } else {
                    // –ï—Å–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–µ—Ç, –Ω–∞—á–∏–Ω–∞–µ–º —Å 1
                    document.getElementById('employee-id-input').value = 1;
                }
            }

            hideEmployeeForm() {
                const form = document.getElementById('employee-form');
                if (form) {
                    form.classList.add('hidden');
                }
            }

            fillEmployeeForm(employee) {
                document.getElementById('employee-id-input').value = employee.id;
                document.getElementById('employee-name').value = employee.name;
                document.getElementById('employee-department').value = employee.department;
                document.getElementById('employee-position').value = employee.position;
                document.getElementById('employee-salary').value = employee.salary;
                document.getElementById('employee-hireDate').value = employee.hireDate;
            }

            async saveEmployee(event) {
                event.preventDefault();
                console.log('üíæ Saving employee...');
                
                try {
                    const employee = {
                        id: parseInt(document.getElementById('employee-id-input').value),
                        name: document.getElementById('employee-name').value,
                        department: document.getElementById('employee-department').value,
                        position: document.getElementById('employee-position').value,
                        salary: parseFloat(document.getElementById('employee-salary').value),
                        hireDate: document.getElementById('employee-hireDate').value
                    };

                    console.log('üì§ Employee data:', employee);

                    // üî• –ü–†–û–í–ï–†–ö–ê –ù–ê –£–ù–ò–ö–ê–õ–¨–ù–û–°–¢–¨ ID (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤)
                    const existingEmployee = this.employees.find(emp => emp.id === employee.id);
                    let result;

                    if (existingEmployee) {
                        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                        result = await this.fetchAPI(`/employees/${employee.id}`, 'PUT', employee);
                    } else {
                        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                        result = await this.fetchAPI('/employees', 'POST', employee);
                    }

                    console.log('üìä Save result:', result);

                    if (result.success) {
                        this.showStatus('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                        this.hideEmployeeForm();
                        await this.loadEmployees();
                    } else {
                        this.showStatus(`–û—à–∏–±–∫–∞: ${result.message}`, 'error');
                    }
                } catch (error) {
                    console.error('üí• Save employee error:', error);
                    this.showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏', 'error');
                }
            }
                    

            editEmployee(id) {
                const employee = this.employees.find(emp => emp.id == id);
                if (employee) {
                    this.showEmployeeForm(employee);
                }
            }

            async loadEmployees() {
                console.log('üë• Loading employees...');
                try {
                    const result = await this.fetchAPI('/employees');
                    console.log('üìä Load employees result:', result);
                    
                    if (result.success) {
                        this.employees = result.data || [];
                        this.renderEmployees();
                        console.log('‚úÖ Employees loaded:', this.employees.length);
                    } else {
                        console.error('‚ùå Failed to load employees:', result.message);
                        this.showStatus(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${result.message}`, 'error');
                    }
                } catch (error) {
                    console.error('üí• Load employees error:', error);
                    this.showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤', 'error');
                }
            }

            async createBackup() {
                try {
                    this.showStatus('–°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞...', 'info');
                    const result = await this.fetchAPI('/backup/create', 'POST');
                    
                    if (result.success) {
                        this.showStatus('–ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                    } else {
                        this.showStatus(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞: ${result.message}`, 'error');
                    }
                } catch (error) {
                    this.showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—ç–∫–∞–ø–∞', 'error');
                }
            }

            // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–∏ –º–µ—Ç–æ–¥—ã –≤ –∫–ª–∞—Å—Å SinglePageApp –ø–æ—Å–ª–µ –º–µ—Ç–æ–¥–∞ saveEmployee

            async deleteEmployee(id) {
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?')) {
                    return;
                }

                try {
                    const result = await this.fetchAPI(`/employees/${id}`, 'DELETE');
                    
                    if (result.success) {
                        this.showStatus('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É–¥–∞–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                        await this.loadEmployees();
                    } else {
                        this.showStatus(`–û—à–∏–±–∫–∞: ${result.message}`, 'error');
                    }
                } catch (error) {
                    this.showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞', 'error');
                }
            }

            async searchEmployees() {
                const name = document.getElementById('search-input').value;
                const department = document.getElementById('department-filter').value;
                
                const queryParams = new URLSearchParams();
                if (name) queryParams.append('name', name);
                if (department) queryParams.append('department', department);
                
                try {
                    const result = await this.fetchAPI(`/employees?${queryParams.toString()}`);
                    
                    if (result.success) {
                        this.employees = result.data || [];
                        this.renderEmployees();
                        this.showStatus(`–ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${this.employees.length}`, 'info');
                    } else {
                        this.showStatus(`–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${result.message}`, 'error');
                    }
                } catch (error) {
                    this.showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ', 'error');
                }
            }

            async clearSearch() {
                document.getElementById('search-input').value = '';
                document.getElementById('department-filter').value = '';
                await this.loadEmployees();
            }

            async exportToExcel() {
                try {
                    this.showStatus('–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö...', 'info');
                    const result = await this.fetchAPI('/export/excel');
                    
                    if (result.success) {
                        this.showStatus('–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                        
                        // üî• –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –°–ö–ê–ß–ò–í–ê–ù–ò–ï –§–ê–ô–õ–ê
                        if (result.data && result.data.filePath) {
                            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                            const filePath = result.data.filePath;
                            const fileName = result.data.fileName || 'export.csv';
                            
                            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ñ–∞–π–ª –∏ —Å–æ–∑–¥–∞–µ–º blob –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                            const response = await fetch(`${this.apiBase}/export/download?file=${encodeURIComponent(filePath)}`);
                            const blob = await response.blob();
                            
                            // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = fileName;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        }
                    } else {
                        this.showStatus(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${result.message}`, 'error');
                    }
                } catch (error) {
                    this.showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ', 'error');
                    console.error('Export error:', error);
                }
            }

            async clearDatabase() {
                if (!confirm('–í–ù–ò–ú–ê–ù–ò–ï! –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                    return;
                }

                try {
                    const result = await this.fetchAPI('/database/clear', 'DELETE');
                    
                    if (result.success) {
                        this.showStatus('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—á–∏—â–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                        await this.loadEmployees();
                    } else {
                        this.showStatus(`–û—à–∏–±–∫–∞: ${result.message}`, 'error');
                    }
                } catch (error) {
                    this.showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ë–î', 'error');
                }
            }

            renderEmployees() {
                const tbody = document.getElementById('employees-table');
                const countElement = document.getElementById('record-count');
                
                if (this.employees.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem;">
                                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                            </td>
                        </tr>
                    `;
                    if (countElement) countElement.textContent = '–ó–∞–ø–∏—Å–µ–π: 0';
                    return;
                }

                tbody.innerHTML = this.employees.map(emp => `
                    <tr>
                        <td>${emp.id}</td>
                        <td>${emp.name}</td>
                        <td>${emp.department}</td>
                        <td>${emp.position}</td>
                        <td>${emp.salary}</td>
                        <td>${emp.hireDate}</td>
                        <td>
                            <button class="btn" onclick="app.editEmployee(${emp.id})">‚úèÔ∏è</button>
                            <button class="btn btn-danger" onclick="app.deleteEmployee(${emp.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');

                if (countElement) countElement.textContent = `–ó–∞–ø–∏—Å–µ–π: ${this.employees.length}`;
            }

            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã (showEmployeeForm, hideEmployeeForm, saveEmployee, editEmployee, deleteEmployee, searchEmployees, clearSearch)
            // –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ –∫–∞–∫ –≤ –≤–∞—à–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º simple-app.js

            async fetchAPI(endpoint, method = 'GET', data = null, useToken = true) {
                const options = {
                    method,
                    headers: { 
                        'Content-Type': 'application/json',
                    },
                    // üî• –£–ë–ò–†–ê–ï–ú credentials: 'include' - –æ–Ω–∏ –Ω–∞–º –Ω–µ –Ω—É–∂–Ω—ã —Å —Ç–æ–∫–µ–Ω–∞–º–∏
                    // credentials: 'include'
                };

                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫
                if (useToken && this.currentToken) {
                    options.headers['Authorization'] = `Bearer ${this.currentToken}`;
                    console.log('üîë Sending token in header:', this.currentToken);
                }

                if (data && (method === 'POST' || method === 'PUT')) {
                    options.body = JSON.stringify(data);
                }

                console.log(`üåê API Call: ${method} ${endpoint}`, options);

                try {
                    const response = await fetch(`${this.apiBase}${endpoint}`, options);
                    const result = await response.json();
                    console.log(`üì® API Response:`, result);
                    return result;
                } catch (error) {
                    console.error(`üí• API Error (${endpoint}):`, error);
                    throw error;
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new SinglePageApp();
            window.app = app;
        });
    </script>
</body>
</html>