Техническое проектирование My_FileDB - Этап 2: API и управление данными
2.1 Архитектура REST API
Общие принципы проектирования
Система реализует RESTful API со следующими характеристиками:

Единообразие интерфейса - стандартные HTTP методы и статус-коды

Статус-независимость - сервер не хранит состояние клиента между запросами

Кэшируемость - продуманные заголовки для кэширования

Слоистая архитектура - клиент не зависит от способа хранения данных

Базовые эндпоинты управления сотрудниками
Метод	URL	Назначение	Статус успеха
GET	/employees	Получить всех сотрудников	200 OK
POST	/employees	Добавить нового сотрудника	201 Created
GET	/employees/{id}	Получить сотрудника по ID	200 OK
PUT	/employees/{id}	Обновить данные сотрудника	200 OK
DELETE	/employees/{id}	Удалить сотрудника по ID	200 OK
Специализированные эндпоинты поиска
Метод	URL	Параметры	Назначение
GET	/employees/search	department, position, name	Гибкий поиск по критериям
GET	/employees/search	minSalary, maxSalary	Поиск по диапазону зарплат
DELETE	/employees	department, position	Массовое удаление по критериям
Эндпоинты управления базой данных
Метод	URL	Назначение	Статус успеха
POST	/database/create	Создать новую БД	201 Created
POST	/database/load	Загрузить существующую БД	200 OK
POST	/database/backup	Создать резервную копию	200 OK
POST	/database/restore	Восстановить из backup	200 OK
DELETE	/database/clear	Очистить все записи	200 OK
DELETE	/database	Полностью удалить БД	200 OK
GET	/database/info	Получить статистику БД	200 OK
POST	/export/excel	Экспорт в Excel	200 OK + binary
2.2 Система валидации и обработки ошибок
Форматы данных
Схема сотрудника:

json
{
  "id": "integer (1-999999, уникальный)",
  "name": "string (max 100 chars, буквы и пробелы)",
  "department": "string (max 50 chars)", 
  "position": "string (max 50 chars)",
  "salary": "number (0-999999.99, 2 decimal places)",
  "hireDate": "string (YYYY-MM-DD format)"
}
Успешный ответ:

json
{
  "success": true,
  "message": "Описательное сообщение",
  "data": "Полезная нагрузка",
  "metadata": "Дополнительная информация"
}
Классификация ошибок
Валидационные ошибки (400 Bad Request):

VALIDATION_ERROR - общая ошибка валидации

INVALID_ID - неверный формат ID

INVALID_SALARY - зарплата вне допустимого диапазона

INVALID_DATE - неверный формат даты

MISSING_REQUIRED_FIELD - отсутствует обязательное поле

Бизнес-логика ошибки (409 Conflict):

DUPLICATE_EMPLOYEE_ID - нарушение уникальности ID

EMPLOYEE_NOT_FOUND - запись не существует

Ошибки "Не найдено" (404 Not Found):

DATABASE_NOT_FOUND - указанная БД не существует

EMPLOYEE_NOT_FOUND - сотрудник не найден

Системные ошибки (500 Internal Server Error):

INTERNAL_SERVER_ERROR - непредвиденная ошибка сервера

DATABASE_CORRUPTED - повреждение файлов БД

Формат ошибки:

json
{
  "success": false,
  "error": "КОД_ОШИБКИ",
  "message": "Человеко-читаемое описание",
  "details": "Дополнительная информация",
  "timestamp": "2024-11-25T15:00:00Z"
}
2.3 Процессы инициализации БД
Создание новой базы данных
Процесс:

Валидация пути - проверка корректности и прав доступа

Проверка существования - предотвращение случайной перезаписи

Создание структуры - инициализация трех файлов БД:

meta.db - заголовок и метаданные (22 байта)

data.db - файл данных записей

index.db - хэш-таблица индексов

Инициализация заголовков - установка начальных значений

Формат meta.db:

text
[Сигнатура:4][Версия:2][Записей:4][СвободноеСмещение:8][РазмерЗаписи:4] = 22 байта
Загрузка существующей БД
Процесс:

Проверка существования - валидация наличия всех файлов БД

Верификация формата - проверка сигнатуры и версии

Загрузка метаданных - чтение заголовка meta.db

Построение индекса в памяти - загрузка index.db в HashMap

Открытие файлов данных - инициализация RandomAccessFile

Проверка целостности - валидация соответствия данных

Валидации при загрузке:

Соответствие размера файла данных количеству записей

Корректность смещений в индексе

Отсутствие битых ссылок

Проверка прав доступа на чтение/запись

Модель управления сессиями
Принципы:

Единая активная БД - в любой момент времени загружена только одна БД

Явное управление - клиент явно указывает какую БД использовать

Атомарные операции - гарантия целостности при переключении БД

Автоматическое закрытие - предыдущая сессия корректно закрывается

Состояние сервера:

java
class ServerState {
    DatabaseSession currentSession; // Текущая активная сессия
    boolean isDatabaseLoaded;      // Флаг загруженной БД
    String loadedDatabasePath;     // Путь к активной БД
}
Интеграция с фронтендом
Типичный сценарий работы:
Инициализация → POST /database/create или POST /database/load

Работа с данными → CRUD операции через /employees/*

Поиск и фильтрация → GET /employees/search?criteria

Администрирование → Операции через /database/* и /export/*

Завершение → Неявное закрытие при остановке сервера

Гарантии целостности:
Валидация на входе - отсев некорректных данных до обработки

Атомарность операций - использование временных файлов для критичных изменений

Контрольные точки - периодическое сохранение состояния

Восстановление при ошибках - откат к предыдущему состоянию при сбоях

Данная архитектура API обеспечивает четкое разделение ответственности, предсказуемое поведение и надежную работу с файловой базой данных через стандартные HTTP-интерфейсы.